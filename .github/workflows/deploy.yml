name: Deploy Lambda Functions

on:
  push:
    branches:
      - main
    paths:
      - '**/*.py'
      - 'requirements.txt'
      - '.github/workflows/deploy.yml'
  workflow_dispatch:

env:
  AWS_REGION: us-west-2

jobs:
  deploy:
    name: Build and Deploy Lambda Functions
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Build API Lambda package
        run: |
          echo "ðŸ“¦ æž„å»º API Lambda éƒ¨ç½²åŒ…..."
          
          # å®‰è£…ä¾èµ–
          pip install -r requirements.txt -t package/
          
          # å¤åˆ¶ä»£ç æ–‡ä»¶
          cp *.py package/
          cp -r collectors package/
          
          # åˆ›å»ºéƒ¨ç½²åŒ…
          cd package
          zip -r ../api-lambda.zip .
          cd ..
          
          echo "âœ… API Lambda åŒ…æž„å»ºå®Œæˆ"
          ls -lh api-lambda.zip

      - name: Build Collector Lambda package
        run: |
          echo "ðŸ“¦ æž„å»º Collector Lambda éƒ¨ç½²åŒ…..."
          
          # ç¡®ä¿ collectors ç›®å½•åœ¨ package ä¸­
          ls -la package/ | grep collectors || echo "Warning: collectors not found"
          
          # åˆ›å»º collector handler
          cat > package/collector_handler.py << 'EOF'
          import os
          from collect_data import main as collect_data_main

          def lambda_handler(event, context):
              print("[START] Starting data collection...")
              try:
                  collect_data_main()
                  print("[OK] Data collection completed")
                  return {
                      'statusCode': 200,
                      'body': 'Data collection completed successfully!'
                  }
              except Exception as e:
                  print(f"[ERROR] Data collection failed: {e}")
                  import traceback
                  traceback.print_exc()
                  return {
                      'statusCode': 500,
                      'body': f'Data collection failed: {e}'
                  }
          EOF
          
          # åˆ›å»ºéƒ¨ç½²åŒ…
          cd package
          zip -r ../collector-lambda.zip .
          cd ..
          
          echo "âœ… Collector Lambda åŒ…æž„å»ºå®Œæˆ"
          ls -lh collector-lambda.zip
          
          # éªŒè¯åŒ…å†…å®¹
          unzip -l collector-lambda.zip | grep collectors || echo "Warning: collectors not in zip"

      - name: Deploy API Lambda
        run: |
          echo "ðŸš€ éƒ¨ç½² API Lambda å‡½æ•°..."
          
          aws lambda update-function-code \
            --function-name resort-data-api \
            --zip-file fileb://api-lambda.zip \
            --region ${{ env.AWS_REGION }}
          
          echo "âœ… API Lambda éƒ¨ç½²æˆåŠŸ"

      - name: Deploy Collector Lambda
        run: |
          echo "ðŸš€ éƒ¨ç½² Collector Lambda å‡½æ•°..."
          
          aws lambda update-function-code \
            --function-name resort-data-collector \
            --zip-file fileb://collector-lambda.zip \
            --region ${{ env.AWS_REGION }}
          
          echo "âœ… Collector Lambda éƒ¨ç½²æˆåŠŸ"

      - name: Deployment Summary
        run: |
          echo ""
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "âœ… Lambda å‡½æ•°éƒ¨ç½²å®Œæˆï¼"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""
          echo "ðŸ“¡ API è®¿é—®åœ°å€:"
          echo "   https://api.steponsnow.com/api/resorts"
          echo ""
          echo "ðŸ”§ éªŒè¯éƒ¨ç½²:"
          echo "   curl https://api.steponsnow.com/api/status"
          echo ""
          echo "ðŸ“Š æŸ¥çœ‹æ—¥å¿—:"
          echo "   AWS Console â†’ CloudWatch Logs"
          echo "   - /aws/lambda/resort-data-api"
          echo "   - /aws/lambda/resort-data-collector"
          echo ""
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
