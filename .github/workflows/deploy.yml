name: Deploy Lambda Functions

on:
  push:
    branches:
      - main
    paths:
      - '**/*.py'
      - 'requirements.txt'
      - 'resorts_config.json'
      - '.github/workflows/deploy.yml'
  workflow_dispatch:

env:
  AWS_REGION: us-west-2

jobs:
  deploy:
    name: Build and Deploy Lambda Functions
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Build API Lambda package
        run: |
          echo "ğŸ“¦ æ„å»º API Lambda éƒ¨ç½²åŒ…ï¼ˆä½¿ç”¨ç²¾ç®€ä¾èµ–ï¼‰..."
          
          # æ¸…ç†æ—§çš„ package ç›®å½•
          rm -rf package
          mkdir -p package
          
          # å®‰è£…ç²¾ç®€çš„ä¾èµ–ï¼ˆAPI Lambda ä¸éœ€è¦ firebase-admin, supabase, beautifulsoup4 ç­‰å¤§å‹åŒ…ï¼‰
          pip install -r requirements-api.txt -t package/
          
          # åªå¤åˆ¶ API Lambda éœ€è¦çš„æ–‡ä»¶
          cp api.py lambda_handler.py config.py db_manager.py models.py package/
          cp resorts_config.json package/
          
          # åˆ›å»ºéƒ¨ç½²åŒ…
          cd package
          zip -r ../api-lambda.zip .
          cd ..
          
          echo "âœ… API Lambda åŒ…æ„å»ºå®Œæˆ"
          ls -lh api-lambda.zip
          
          # æ˜¾ç¤ºåŒ…å¤§å°
          SIZE=$(du -h api-lambda.zip | cut -f1)
          echo "ğŸ“¦ éƒ¨ç½²åŒ…å¤§å°: $SIZE"

      - name: Build Collector Lambda package
        run: |
          echo "ğŸ“¦ æ„å»º Collector Lambda éƒ¨ç½²åŒ…..."
          
          # æ¸…ç†å¹¶é‡æ–°åˆ›å»º package ç›®å½•
          rm -rf package
          mkdir -p package
          
          # å®‰è£…å®Œæ•´ä¾èµ–ï¼ˆCollector éœ€è¦æ‰€æœ‰ä¾èµ–ï¼‰
          pip install -r requirements.txt -t package/
          
          # å¤åˆ¶æ‰€æœ‰å¿…è¦çš„ä»£ç æ–‡ä»¶
          cp config.py db_manager.py models.py normalizer.py failure_tracker.py resort_manager.py package/
          cp resorts_config.json package/
          cp -r collectors package/
          cp collector_handler.py package/
          
          echo "âœ… Collector Lambda åŒ…æ„å»ºå®Œæˆ"
          
          # åˆ›å»ºéƒ¨ç½²åŒ…
          cd package
          zip -r ../collector-lambda.zip .
          cd ..
          
          ls -lh collector-lambda.zip
          
          # æ˜¾ç¤ºåŒ…å¤§å°
          SIZE=$(du -h collector-lambda.zip | cut -f1)
          echo "ğŸ“¦ éƒ¨ç½²åŒ…å¤§å°: $SIZE"
          
          # éªŒè¯åŒ…å†…å®¹
          echo "ğŸ“‹ éªŒè¯éƒ¨ç½²åŒ…å†…å®¹..."
          unzip -l collector-lambda.zip | grep -E "(collector_handler|collectors|resort_manager)" || echo "Warning: missing files"

      - name: Deploy API Lambda
        run: |
          echo "ğŸš€ éƒ¨ç½² API Lambda å‡½æ•°..."
          
          aws lambda update-function-code \
            --function-name resort-data-api \
            --zip-file fileb://api-lambda.zip \
            --region ${{ env.AWS_REGION }}
          
          echo "âœ… API Lambda éƒ¨ç½²æˆåŠŸ"

      - name: Upload Collector Lambda to S3
        run: |
          echo "â˜ï¸ ä¸Šä¼  Collector Lambda åˆ° S3..."
          
          BUCKET="resort-data-lambda-artifacts-579866932024"
          
          echo "ğŸ“¦ ä½¿ç”¨ S3 Bucket: $BUCKET"
          
          # ä¸Šä¼ åˆ° S3
          aws s3 cp collector-lambda.zip "s3://${BUCKET}/collector-lambda.zip" \
            --region ${{ env.AWS_REGION }}
          
          echo "âœ… ä¸Šä¼ åˆ° S3 æˆåŠŸ"

      - name: Deploy Collector Lambda
        run: |
          echo "ğŸš€ éƒ¨ç½² Collector Lambda å‡½æ•°ï¼ˆä» S3ï¼‰..."
          
          BUCKET="resort-data-lambda-artifacts-579866932024"
          
          aws lambda update-function-code \
            --function-name resort-data-collector \
            --s3-bucket "$BUCKET" \
            --s3-key "collector-lambda.zip" \
            --region ${{ env.AWS_REGION }}
          
          echo "âœ… Collector Lambda éƒ¨ç½²æˆåŠŸ"
          
          echo "â³ ç­‰å¾… Lambda æ›´æ–°å®Œæˆ..."
          aws lambda wait function-updated \
            --function-name resort-data-collector \
            --region ${{ env.AWS_REGION }} || true
          
          echo "ğŸ”§ æ›´æ–° Collector Lambda ç¯å¢ƒå˜é‡ (Open-Meteo API Key)..."
          
          # è·å–ç°æœ‰ç¯å¢ƒå˜é‡
          EXISTING_ENV=$(aws lambda get-function-configuration \
            --function-name resort-data-collector \
            --region ${{ env.AWS_REGION }} \
            --query 'Environment.Variables' \
            --output json)
          
          echo "ç°æœ‰ç¯å¢ƒå˜é‡: $EXISTING_ENV"
          
          # ä½¿ç”¨ jq æ·»åŠ  OPENMETEO_API_KEY
          UPDATED_ENV=$(echo "$EXISTING_ENV" | jq '. + {"OPENMETEO_API_KEY": "${{ secrets.OPENMETEO_API_KEY }}"}')
          
          echo "æ›´æ–°åçš„ç¯å¢ƒå˜é‡: $UPDATED_ENV"
          
          # å†™å…¥ä¸´æ—¶æ–‡ä»¶
          echo "{\"Variables\": $UPDATED_ENV}" > collector_env.json
          
          # æ›´æ–° Lambda é…ç½®
          aws lambda update-function-configuration \
            --function-name resort-data-collector \
            --environment file://collector_env.json \
            --region ${{ env.AWS_REGION }}
          
          rm collector_env.json
          
          echo "âœ… Collector Lambda ç¯å¢ƒå˜é‡æ›´æ–°å®Œæˆ"

      - name: Build Contact Collector Lambda
        run: |
          echo "ğŸ“¦ æ„å»º Contact Collector Lambda åŒ…..."
          
          # åˆ›å»ºä¸´æ—¶ç›®å½•
          mkdir -p package-contact
          
          # å®‰è£…ä¾èµ–
          pip install -r requirements.txt -t package-contact/ --upgrade
          
          # å¤åˆ¶åŸºç¡€ä»£ç æ–‡ä»¶
          cp config.py db_manager.py models.py normalizer.py failure_tracker.py package-contact/
          cp resorts_config.json package-contact/
          
          # å¤åˆ¶ collectors ç›®å½•
          cp -r collectors package-contact/
          
          # ç›´æ¥å¤åˆ¶ç°æœ‰çš„ handler æ–‡ä»¶ï¼ˆä¸å†é‡æ–°ç”Ÿæˆï¼‰
          cp contact_collector_handler.py package-contact/
          
          # åˆ›å»ºéƒ¨ç½²åŒ…
          cd package-contact
          zip -r ../contact-collector-lambda.zip .
          cd ..
          
          echo "âœ… Contact Collector Lambda åŒ…æ„å»ºå®Œæˆ"
          ls -lh contact-collector-lambda.zip
          
          # éªŒè¯åŒ…å†…å®¹
          echo "ğŸ“‹ éªŒè¯éƒ¨ç½²åŒ…å†…å®¹..."
          unzip -l contact-collector-lambda.zip | grep -E "(contact_collector_handler|collectors|db_manager)" || echo "Warning: missing files"

      - name: Upload Contact Collector Lambda to S3
        run: |
          echo "â˜ï¸ ä¸Šä¼  Contact Collector Lambda åˆ° S3..."
          
          BUCKET="resort-data-lambda-artifacts-579866932024"
          
          aws s3 cp contact-collector-lambda.zip "s3://${BUCKET}/contact-collector-lambda.zip" \
            --region ${{ env.AWS_REGION }}
          
          echo "âœ… ä¸Šä¼ åˆ° S3 æˆåŠŸ"

      - name: Deploy Contact Collector Lambda
        run: |
          echo "ğŸš€ éƒ¨ç½² Contact Collector Lambda å‡½æ•°ï¼ˆä» S3ï¼‰..."
          
          BUCKET="resort-data-lambda-artifacts-579866932024"
          
          aws lambda update-function-code \
            --function-name resort-data-contact-collector \
            --s3-bucket "$BUCKET" \
            --s3-key "contact-collector-lambda.zip" \
            --region ${{ env.AWS_REGION }}
          
          echo "âœ… Contact Collector Lambda éƒ¨ç½²æˆåŠŸ"
          
          echo "â³ ç­‰å¾… Lambda æ›´æ–°å®Œæˆ..."
          aws lambda wait function-updated \
            --function-name resort-data-contact-collector \
            --region ${{ env.AWS_REGION }} || true
          
          echo "ğŸ”§ æ›´æ–° Contact Collector Lambda ç¯å¢ƒå˜é‡ (Google Maps API Key)..."
          
          # è·å–ç°æœ‰ç¯å¢ƒå˜é‡
          EXISTING_ENV=$(aws lambda get-function-configuration \
            --function-name resort-data-contact-collector \
            --region ${{ env.AWS_REGION }} \
            --query 'Environment.Variables' \
            --output json)
          
          echo "ç°æœ‰ç¯å¢ƒå˜é‡: $EXISTING_ENV"
          
          # ä½¿ç”¨ jq æ·»åŠ  GOOGLE_MAPS_API_KEY
          UPDATED_ENV=$(echo "$EXISTING_ENV" | jq '. + {"GOOGLE_MAPS_API_KEY": "${{ secrets.GOOGLE_MAPS_API_KEY }}"}')
          
          echo "æ›´æ–°åçš„ç¯å¢ƒå˜é‡: $UPDATED_ENV"
          
          # å†™å…¥ä¸´æ—¶æ–‡ä»¶
          echo "{\"Variables\": $UPDATED_ENV}" > contact_env.json
          
          # æ›´æ–° Lambda é…ç½®
          aws lambda update-function-configuration \
            --function-name resort-data-contact-collector \
            --environment file://contact_env.json \
            --region ${{ env.AWS_REGION }}
          
          rm contact_env.json
          
          echo "âœ… Contact Collector Lambda ç¯å¢ƒå˜é‡æ›´æ–°å®Œæˆ"

      - name: Build Notification Handler Lambda
        run: |
          echo "ğŸ“¦ æ„å»º Notification Handler Lambda åŒ…..."
          
          # æ¸…ç†å¹¶é‡æ–°åˆ›å»ºä¸´æ—¶ç›®å½•
          rm -rf package-notification
          mkdir -p package-notification
          
          # å¤åˆ¶ä»£ç 
          cp notification_handler.py push_service.py package-notification/
          
          # å®‰è£…ä¾èµ–
          pip install -r requirements.txt -t package-notification/ --upgrade
          
          # åˆ›å»ºéƒ¨ç½²åŒ…
          cd package-notification
          zip -r ../notification-handler.zip .
          cd ..
          
          echo "âœ… Notification Handler Lambda åŒ…æ„å»ºå®Œæˆ"
          ls -lh notification-handler.zip
          
          # æ˜¾ç¤ºåŒ…å¤§å°
          SIZE=$(du -h notification-handler.zip | cut -f1)
          echo "ğŸ“¦ éƒ¨ç½²åŒ…å¤§å°: $SIZE"

      - name: Build Snow Checker Lambda
        run: |
          echo "ğŸ“¦ æ„å»º Snow Checker Lambda åŒ…..."
          
          # åˆ›å»ºä¸´æ—¶ç›®å½•
          mkdir -p package-snow
          
          # å¤åˆ¶ä»£ç 
          cp check_snow_and_notify.py push_service.py package-snow/
          
          # å®‰è£…ä¾èµ–
          pip install -r requirements.txt -t package-snow/ --upgrade
          
          # åˆ›å»ºéƒ¨ç½²åŒ…
          cd package-snow
          zip -r ../snow-checker.zip .
          cd ..
          
          echo "âœ… Snow Checker Lambda åŒ…æ„å»ºå®Œæˆ"
          ls -lh snow-checker.zip

      - name: Build SQS Notification Processor Lambda
        run: |
          echo "ğŸ“¦ æ„å»º SQS Notification Processor Lambda åŒ…..."
          
          # åˆ›å»ºä¸´æ—¶ç›®å½•
          mkdir -p package-sqs
          
          # å¤åˆ¶ä»£ç 
          cp sqs_notification_processor.py push_service.py package-sqs/
          
          # å®‰è£… Lambda ä¸“ç”¨ä¾èµ–
          pip install -r requirements-lambda.txt -t package-sqs/ --upgrade
          
          # åˆ›å»ºéƒ¨ç½²åŒ…
          cd package-sqs
          zip -r ../sqs-notification-processor.zip .
          cd ..
          
          echo "âœ… SQS Notification Processor Lambda åŒ…æ„å»ºå®Œæˆ"
          ls -lh sqs-notification-processor.zip

      - name: Upload Notification Handler Lambda to S3
        run: |
          echo "â˜ï¸ ä¸Šä¼  Notification Handler Lambda åˆ° S3..."
          
          BUCKET="resort-data-lambda-artifacts-579866932024"
          
          aws s3 cp notification-handler.zip "s3://${BUCKET}/notification-handler.zip" \
            --region ${{ env.AWS_REGION }}
          
          echo "âœ… ä¸Šä¼ åˆ° S3 æˆåŠŸ"

      - name: Deploy Notification Handler Lambda
        run: |
          echo "ğŸš€ éƒ¨ç½² Notification Handler Lambda å‡½æ•°ï¼ˆä» S3ï¼‰..."
          
          BUCKET="resort-data-lambda-artifacts-579866932024"
          
          aws lambda update-function-code \
            --function-name resort-data-notification-handler \
            --s3-bucket "$BUCKET" \
            --s3-key "notification-handler.zip" \
            --region ${{ env.AWS_REGION }}
          
          echo "âœ… Notification Handler Lambda éƒ¨ç½²æˆåŠŸ"

      - name: Upload Snow Checker Lambda to S3
        run: |
          echo "â˜ï¸ ä¸Šä¼  Snow Checker Lambda åˆ° S3..."
          
          BUCKET="resort-data-lambda-artifacts-579866932024"
          
          aws s3 cp snow-checker.zip "s3://${BUCKET}/snow-checker.zip" \
            --region ${{ env.AWS_REGION }}
          
          echo "âœ… ä¸Šä¼ åˆ° S3 æˆåŠŸ"

      - name: Deploy Snow Checker Lambda
        run: |
          echo "ğŸš€ éƒ¨ç½² Snow Checker Lambda å‡½æ•°ï¼ˆä» S3ï¼‰..."
          
          BUCKET="resort-data-lambda-artifacts-579866932024"
          
          aws lambda update-function-code \
            --function-name resort-data-snow-checker \
            --s3-bucket "$BUCKET" \
            --s3-key "snow-checker.zip" \
            --region ${{ env.AWS_REGION }}
          
          echo "âœ… Snow Checker Lambda éƒ¨ç½²æˆåŠŸ"
          echo "â³ ç­‰å¾… Lambda æ›´æ–°å®Œæˆ..."
          sleep 10

      - name: Upload SQS Notification Processor Lambda to S3
        run: |
          echo "â˜ï¸ ä¸Šä¼  SQS Notification Processor Lambda åˆ° S3..."
          
          BUCKET="resort-data-lambda-artifacts-579866932024"
          
          aws s3 cp sqs-notification-processor.zip "s3://${BUCKET}/sqs-notification-processor.zip" \
            --region ${{ env.AWS_REGION }}
          
          echo "âœ… ä¸Šä¼ åˆ° S3 æˆåŠŸ"

      - name: Deploy SQS Notification Processor Lambda
        run: |
          echo "ğŸš€ éƒ¨ç½² SQS Notification Processor Lambda å‡½æ•°ï¼ˆä» S3ï¼‰..."
          
          BUCKET="resort-data-lambda-artifacts-579866932024"
          
          aws lambda update-function-code \
            --function-name resort-data-sqs-notification-processor \
            --s3-bucket "$BUCKET" \
            --s3-key "sqs-notification-processor.zip" \
            --region ${{ env.AWS_REGION }}
          
          echo "âœ… SQS Notification Processor Lambda éƒ¨ç½²æˆåŠŸ"

      - name: Update Lambda Environment Variables
        run: |
          echo "ğŸ”§ æ›´æ–° Lambda ç¯å¢ƒå˜é‡ï¼ˆFirebase é…ç½®ï¼‰..."
          
          # ç­‰å¾…æ‰€æœ‰ Lambda å‡½æ•°æ›´æ–°å®Œæˆ
          echo "â³ ç­‰å¾…æ‰€æœ‰ Lambda å‡½æ•°å°±ç»ª..."
          aws lambda wait function-updated \
            --function-name resort-data-notification-handler \
            --region ${{ env.AWS_REGION }} || true
          
          aws lambda wait function-updated \
            --function-name resort-data-snow-checker \
            --region ${{ env.AWS_REGION }} || true
          
          aws lambda wait function-updated \
            --function-name resort-data-sqs-notification-processor \
            --region ${{ env.AWS_REGION }} || true
          
          echo "âœ… æ‰€æœ‰ Lambda å‡½æ•°å·²å°±ç»ª"
          
          # æ›´æ–° Notification Handler ç¯å¢ƒå˜é‡
          echo "ğŸ”§ æ›´æ–° Notification Handler ç¯å¢ƒå˜é‡..."
          
          # ä½¿ç”¨ jq æ„å»º JSONï¼Œæ­£ç¡®å¤„ç†æ¢è¡Œç¬¦
          jq -n \
            --arg supabase_url "${{ secrets.SUPABASE_URL }}" \
            --arg supabase_key "${{ secrets.SUPABASE_SERVICE_KEY }}" \
            --arg firebase_project "${{ secrets.FIREBASE_PROJECT_ID }}" \
            --arg firebase_key_id "${{ secrets.FIREBASE_PRIVATE_KEY_ID }}" \
            --arg firebase_key "${{ secrets.FIREBASE_PRIVATE_KEY }}" \
            --arg firebase_email "${{ secrets.FIREBASE_CLIENT_EMAIL }}" \
            --arg firebase_client_id "${{ secrets.FIREBASE_CLIENT_ID }}" \
            '{
              Variables: {
                SUPABASE_URL: $supabase_url,
                SUPABASE_SERVICE_KEY: $supabase_key,
                FIREBASE_PROJECT_ID: $firebase_project,
                FIREBASE_PRIVATE_KEY_ID: $firebase_key_id,
                FIREBASE_PRIVATE_KEY: $firebase_key,
                FIREBASE_CLIENT_EMAIL: $firebase_email,
                FIREBASE_CLIENT_ID: $firebase_client_id
              }
            }' > env_handler_final.json
          
          aws lambda update-function-configuration \
            --function-name resort-data-notification-handler \
            --environment file://env_handler_final.json \
            --region ${{ env.AWS_REGION }}
          
          rm env_handler_final.json
          
          echo "âœ… Notification Handler ç¯å¢ƒå˜é‡æ›´æ–°å®Œæˆ"
          echo "â³ ç­‰å¾…æ›´æ–°å®Œæˆ..."
          sleep 5
          
          # æ›´æ–° Snow Checker ç¯å¢ƒå˜é‡
          echo "ğŸ”§ æ›´æ–° Snow Checker ç¯å¢ƒå˜é‡..."
          
          # ä½¿ç”¨ jq æ„å»º JSONï¼Œæ­£ç¡®å¤„ç†æ¢è¡Œç¬¦
          jq -n \
            --arg db_host "${{ secrets.DB_HOST }}" \
            --arg db_name "${{ secrets.DB_NAME }}" \
            --arg db_user "${{ secrets.DB_USER }}" \
            --arg db_password "${{ secrets.DB_PASSWORD }}" \
            --arg redis_host "${{ secrets.REDIS_HOST }}" \
            --arg redis_port "${{ secrets.REDIS_PORT }}" \
            --arg firebase_project "${{ secrets.FIREBASE_PROJECT_ID }}" \
            --arg firebase_key_id "${{ secrets.FIREBASE_PRIVATE_KEY_ID }}" \
            --arg firebase_key "${{ secrets.FIREBASE_PRIVATE_KEY }}" \
            --arg firebase_email "${{ secrets.FIREBASE_CLIENT_EMAIL }}" \
            --arg firebase_client_id "${{ secrets.FIREBASE_CLIENT_ID }}" \
            '{
              Variables: {
                DB_HOST: $db_host,
                DB_NAME: $db_name,
                DB_USER: $db_user,
                DB_PASSWORD: $db_password,
                REDIS_HOST: $redis_host,
                REDIS_PORT: $redis_port,
                FIREBASE_PROJECT_ID: $firebase_project,
                FIREBASE_PRIVATE_KEY_ID: $firebase_key_id,
                FIREBASE_PRIVATE_KEY: $firebase_key,
                FIREBASE_CLIENT_EMAIL: $firebase_email,
                FIREBASE_CLIENT_ID: $firebase_client_id
              }
            }' > env_snow_final.json
          
          aws lambda update-function-configuration \
            --function-name resort-data-snow-checker \
            --environment file://env_snow_final.json \
            --region ${{ env.AWS_REGION }}
          
          rm env_snow_final.json
          
          echo "âœ… Snow Checker ç¯å¢ƒå˜é‡æ›´æ–°å®Œæˆ"
          echo "â³ ç­‰å¾…æ›´æ–°å®Œæˆ..."
          sleep 5
          
          # æ›´æ–° SQS Notification Processor ç¯å¢ƒå˜é‡
          echo "ğŸ”§ æ›´æ–° SQS Notification Processor ç¯å¢ƒå˜é‡..."
          
          # ä½¿ç”¨ jq æ„å»º JSONï¼Œæ­£ç¡®å¤„ç†æ¢è¡Œç¬¦
          jq -n \
            --arg supabase_url "${{ secrets.SUPABASE_URL }}" \
            --arg supabase_key "${{ secrets.SUPABASE_SERVICE_KEY }}" \
            --arg firebase_project "${{ secrets.FIREBASE_PROJECT_ID }}" \
            --arg firebase_key_id "${{ secrets.FIREBASE_PRIVATE_KEY_ID }}" \
            --arg firebase_key "${{ secrets.FIREBASE_PRIVATE_KEY }}" \
            --arg firebase_email "${{ secrets.FIREBASE_CLIENT_EMAIL }}" \
            --arg firebase_client_id "${{ secrets.FIREBASE_CLIENT_ID }}" \
            '{
              Variables: {
                SUPABASE_URL: $supabase_url,
                SUPABASE_SERVICE_KEY: $supabase_key,
                FIREBASE_PROJECT_ID: $firebase_project,
                FIREBASE_PRIVATE_KEY_ID: $firebase_key_id,
                FIREBASE_PRIVATE_KEY: $firebase_key,
                FIREBASE_CLIENT_EMAIL: $firebase_email,
                FIREBASE_CLIENT_ID: $firebase_client_id
              }
            }' > env_final.json
          
          aws lambda update-function-configuration \
            --function-name resort-data-sqs-notification-processor \
            --environment file://env_final.json \
            --region ${{ env.AWS_REGION }}
          
          rm env_final.json
          
          echo "âœ… æ‰€æœ‰ç¯å¢ƒå˜é‡æ›´æ–°æˆåŠŸ"

      - name: Trigger Initial Data Collection
        run: |
          echo "ğŸ¯ è§¦å‘ä¸€æ¬¡æ•°æ®é‡‡é›†..."
          
          # ç­‰å¾… Collector Lambda æ›´æ–°å®Œæˆ
          aws lambda wait function-updated \
            --function-name resort-data-collector \
            --region ${{ env.AWS_REGION }} || true
          
          # è°ƒç”¨ Collector Lambda
          aws lambda invoke \
            --function-name resort-data-collector \
            --invocation-type Event \
            --region ${{ env.AWS_REGION }} \
            response.json
          
          echo "âœ… æ•°æ®é‡‡é›†ä»»åŠ¡å·²å¯åŠ¨ï¼ˆå¼‚æ­¥æ‰§è¡Œï¼‰"
          echo "ğŸ“Š æŸ¥çœ‹é‡‡é›†æ—¥å¿—:"
          echo "   AWS Console â†’ CloudWatch Logs â†’ /aws/lambda/resort-data-collector"

      - name: Deployment Summary
        run: |
          echo ""
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "âœ… Lambda å‡½æ•°éƒ¨ç½²å®Œæˆï¼"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""
          echo "ğŸ“¡ API è®¿é—®åœ°å€:"
          echo "   https://api.steponsnow.com/api/resorts"
          echo ""
          echo "ğŸ¯ æ•°æ®é‡‡é›†:"
          echo "   âœ… éƒ¨ç½²åè‡ªåŠ¨è§¦å‘äº†ä¸€æ¬¡æ•°æ®é‡‡é›†"
          echo "   â° å®šæ—¶ä»»åŠ¡: æ¯3å°æ—¶è‡ªåŠ¨é‡‡é›†"
          echo ""
          echo "ğŸ”§ éªŒè¯éƒ¨ç½²:"
          echo "   curl https://api.steponsnow.com/api/status"
          echo ""
          echo "ğŸ“Š æŸ¥çœ‹æ—¥å¿—:"
          echo "   AWS Console â†’ CloudWatch Logs"
          echo "   - /aws/lambda/resort-data-api"
          echo "   - /aws/lambda/resort-data-collector"
          echo "   - /aws/lambda/resort-data-notification-handler"
          echo "   - /aws/lambda/resort-data-snow-checker"
          echo ""
          echo "ğŸ”” æ¨é€é€šçŸ¥:"
          echo "   - Notification Handler: æ¯åˆ†é’Ÿæ£€æŸ¥é˜Ÿåˆ—"
          echo "   - Snow Checker: æ¯å°æ—¶æ£€æŸ¥é™é›ª"
          echo ""
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
