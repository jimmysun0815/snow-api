name: Deploy Lambda Functions

on:
  push:
    branches:
      - main
    paths:
      - '**/*.py'
      - 'requirements.txt'
      - 'resorts_config.json'
      - '.github/workflows/deploy.yml'
  workflow_dispatch:

env:
  AWS_REGION: us-west-2

jobs:
  deploy:
    name: Build and Deploy Lambda Functions
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Build API Lambda package
        run: |
          echo "ğŸ“¦ æ„å»º API Lambda éƒ¨ç½²åŒ…..."
          
          # å®‰è£…ä¾èµ–
          pip install -r requirements.txt -t package/
          
          # å¤åˆ¶ä»£ç æ–‡ä»¶
          cp *.py package/
          cp *.json package/
          cp -r collectors package/
          
          # åˆ›å»ºéƒ¨ç½²åŒ…
          cd package
          zip -r ../api-lambda.zip .
          cd ..
          
          echo "âœ… API Lambda åŒ…æ„å»ºå®Œæˆ"
          ls -lh api-lambda.zip

      - name: Build Collector Lambda package
        run: |
          echo "ğŸ“¦ æ„å»º Collector Lambda éƒ¨ç½²åŒ…..."
          
          # ç¡®ä¿ collectors ç›®å½•åœ¨ package ä¸­
          ls -la package/ | grep collectors || echo "Warning: collectors not found"
          
          # åˆ›å»º collector handler
          cat > package/collector_handler.py << 'EOF'
          import os
          from collect_data import main as collect_data_main

          def lambda_handler(event, context):
              print("[START] Starting data collection...")
              try:
                  collect_data_main()
                  print("[OK] Data collection completed")
                  return {
                      'statusCode': 200,
                      'body': 'Data collection completed successfully!'
                  }
              except Exception as e:
                  print(f"[ERROR] Data collection failed: {e}")
                  import traceback
                  traceback.print_exc()
                  return {
                      'statusCode': 500,
                      'body': f'Data collection failed: {e}'
                  }
          EOF
          
          # åˆ›å»ºéƒ¨ç½²åŒ…
          cd package
          zip -r ../collector-lambda.zip .
          cd ..
          
          echo "âœ… Collector Lambda åŒ…æ„å»ºå®Œæˆ"
          ls -lh collector-lambda.zip
          
          # éªŒè¯åŒ…å†…å®¹
          unzip -l collector-lambda.zip | grep collectors || echo "Warning: collectors not in zip"

      - name: Deploy API Lambda
        run: |
          echo "ğŸš€ éƒ¨ç½² API Lambda å‡½æ•°..."
          
          aws lambda update-function-code \
            --function-name resort-data-api \
            --zip-file fileb://api-lambda.zip \
            --region ${{ env.AWS_REGION }}
          
          echo "âœ… API Lambda éƒ¨ç½²æˆåŠŸ"

      - name: Deploy Collector Lambda
        run: |
          echo "ğŸš€ éƒ¨ç½² Collector Lambda å‡½æ•°..."
          
          aws lambda update-function-code \
            --function-name resort-data-collector \
            --zip-file fileb://collector-lambda.zip \
            --region ${{ env.AWS_REGION }}
          
          echo "âœ… Collector Lambda éƒ¨ç½²æˆåŠŸ"
          
          echo "â³ ç­‰å¾… Lambda æ›´æ–°å®Œæˆ..."
          aws lambda wait function-updated \
            --function-name resort-data-collector \
            --region ${{ env.AWS_REGION }} || true
          
          echo "ğŸ”§ æ›´æ–° Collector Lambda ç¯å¢ƒå˜é‡ (Open-Meteo API Key)..."
          aws lambda update-function-configuration \
            --function-name resort-data-collector \
            --environment "Variables={
              OPENMETEO_API_KEY=${{ secrets.OPENMETEO_API_KEY }}
            }" \
            --region ${{ env.AWS_REGION }}
          
          echo "âœ… Collector Lambda ç¯å¢ƒå˜é‡æ›´æ–°å®Œæˆ"

      - name: Build Notification Handler Lambda
        run: |
          echo "ğŸ“¦ æ„å»º Notification Handler Lambda åŒ…..."
          
          # åˆ›å»ºä¸´æ—¶ç›®å½•
          mkdir -p package
          
          # å¤åˆ¶ä»£ç 
          cp notification_handler.py push_service.py package/
          
          # å®‰è£…ä¾èµ–
          pip install -r requirements.txt -t package/ --upgrade
          
          # åˆ›å»ºéƒ¨ç½²åŒ…
          cd package
          zip -r ../notification-handler.zip .
          cd ..
          
          echo "âœ… Notification Handler Lambda åŒ…æ„å»ºå®Œæˆ"
          ls -lh notification-handler.zip

      - name: Build Snow Checker Lambda
        run: |
          echo "ğŸ“¦ æ„å»º Snow Checker Lambda åŒ…..."
          
          # åˆ›å»ºä¸´æ—¶ç›®å½•
          mkdir -p package-snow
          
          # å¤åˆ¶ä»£ç 
          cp check_snow_and_notify.py push_service.py package-snow/
          
          # å®‰è£…ä¾èµ–
          pip install -r requirements.txt -t package-snow/ --upgrade
          
          # åˆ›å»ºéƒ¨ç½²åŒ…
          cd package-snow
          zip -r ../snow-checker.zip .
          cd ..
          
          echo "âœ… Snow Checker Lambda åŒ…æ„å»ºå®Œæˆ"
          ls -lh snow-checker.zip

      - name: Build SQS Notification Processor Lambda
        run: |
          echo "ğŸ“¦ æ„å»º SQS Notification Processor Lambda åŒ…..."
          
          # åˆ›å»ºä¸´æ—¶ç›®å½•
          mkdir -p package-sqs
          
          # å¤åˆ¶ä»£ç 
          cp sqs_notification_processor.py push_service.py package-sqs/
          
          # å®‰è£… Lambda ä¸“ç”¨ä¾èµ–
          pip install -r requirements-lambda.txt -t package-sqs/ --upgrade
          
          # åˆ›å»ºéƒ¨ç½²åŒ…
          cd package-sqs
          zip -r ../sqs-notification-processor.zip .
          cd ..
          
          echo "âœ… SQS Notification Processor Lambda åŒ…æ„å»ºå®Œæˆ"
          ls -lh sqs-notification-processor.zip

      - name: Deploy Notification Handler Lambda
        run: |
          echo "ğŸš€ éƒ¨ç½² Notification Handler Lambda å‡½æ•°..."
          
          aws lambda update-function-code \
            --function-name resort-data-notification-handler \
            --zip-file fileb://notification-handler.zip \
            --region ${{ env.AWS_REGION }}
          
          echo "âœ… Notification Handler Lambda éƒ¨ç½²æˆåŠŸ"

      - name: Deploy Snow Checker Lambda
        run: |
          echo "ğŸš€ éƒ¨ç½² Snow Checker Lambda å‡½æ•°..."
          
          aws lambda update-function-code \
            --function-name resort-data-snow-checker \
            --zip-file fileb://snow-checker.zip \
            --region ${{ env.AWS_REGION }}
          
          echo "âœ… Snow Checker Lambda éƒ¨ç½²æˆåŠŸ"
          echo "â³ ç­‰å¾… Lambda æ›´æ–°å®Œæˆ..."
          sleep 10

      - name: Deploy SQS Notification Processor Lambda
        run: |
          echo "ğŸš€ éƒ¨ç½² SQS Notification Processor Lambda å‡½æ•°..."
          
          aws lambda update-function-code \
            --function-name resort-data-sqs-notification-processor \
            --zip-file fileb://sqs-notification-processor.zip \
            --region ${{ env.AWS_REGION }}
          
          echo "âœ… SQS Notification Processor Lambda éƒ¨ç½²æˆåŠŸ"

      - name: Update Lambda Environment Variables
        run: |
          echo "ğŸ”§ æ›´æ–° Lambda ç¯å¢ƒå˜é‡ï¼ˆFirebase é…ç½®ï¼‰..."
          
          # ç­‰å¾…æ‰€æœ‰ Lambda å‡½æ•°æ›´æ–°å®Œæˆ
          echo "â³ ç­‰å¾…æ‰€æœ‰ Lambda å‡½æ•°å°±ç»ª..."
          aws lambda wait function-updated \
            --function-name resort-data-notification-handler \
            --region ${{ env.AWS_REGION }} || true
          
          aws lambda wait function-updated \
            --function-name resort-data-snow-checker \
            --region ${{ env.AWS_REGION }} || true
          
          aws lambda wait function-updated \
            --function-name resort-data-sqs-notification-processor \
            --region ${{ env.AWS_REGION }} || true
          
          echo "âœ… æ‰€æœ‰ Lambda å‡½æ•°å·²å°±ç»ª"
          
          # æ›´æ–° Notification Handler ç¯å¢ƒå˜é‡
          echo "ğŸ”§ æ›´æ–° Notification Handler ç¯å¢ƒå˜é‡..."
          
          cat > env_handler.json << 'EOF'
          {
            "Variables": {
              "SUPABASE_URL": "$SUPABASE_URL",
              "SUPABASE_SERVICE_KEY": "$SUPABASE_SERVICE_KEY",
              "FIREBASE_PROJECT_ID": "$FIREBASE_PROJECT_ID",
              "FIREBASE_PRIVATE_KEY_ID": "$FIREBASE_PRIVATE_KEY_ID",
              "FIREBASE_PRIVATE_KEY": "$FIREBASE_PRIVATE_KEY",
              "FIREBASE_CLIENT_EMAIL": "$FIREBASE_CLIENT_EMAIL",
              "FIREBASE_CLIENT_ID": "$FIREBASE_CLIENT_ID"
            }
          }
          EOF
          
          export SUPABASE_URL="${{ secrets.SUPABASE_URL }}"
          export SUPABASE_SERVICE_KEY="${{ secrets.SUPABASE_SERVICE_KEY }}"
          export FIREBASE_PROJECT_ID="${{ secrets.FIREBASE_PROJECT_ID }}"
          export FIREBASE_PRIVATE_KEY_ID="${{ secrets.FIREBASE_PRIVATE_KEY_ID }}"
          export FIREBASE_PRIVATE_KEY="${{ secrets.FIREBASE_PRIVATE_KEY }}"
          export FIREBASE_CLIENT_EMAIL="${{ secrets.FIREBASE_CLIENT_EMAIL }}"
          export FIREBASE_CLIENT_ID="${{ secrets.FIREBASE_CLIENT_ID }}"
          
          envsubst < env_handler.json > env_handler_final.json
          
          aws lambda update-function-configuration \
            --function-name resort-data-notification-handler \
            --environment file://env_handler_final.json \
            --region ${{ env.AWS_REGION }}
          
          rm env_handler.json env_handler_final.json
          
          echo "âœ… Notification Handler ç¯å¢ƒå˜é‡æ›´æ–°å®Œæˆ"
          echo "â³ ç­‰å¾…æ›´æ–°å®Œæˆ..."
          sleep 5
          
          # æ›´æ–° Snow Checker ç¯å¢ƒå˜é‡
          echo "ğŸ”§ æ›´æ–° Snow Checker ç¯å¢ƒå˜é‡..."
          
          cat > env_snow.json << 'EOF'
{
  "Variables": {
    "DB_HOST": "$DB_HOST",
    "DB_NAME": "$DB_NAME",
    "DB_USER": "$DB_USER",
    "DB_PASSWORD": "$DB_PASSWORD",
    "REDIS_HOST": "$REDIS_HOST",
    "REDIS_PORT": "$REDIS_PORT",
    "FIREBASE_PROJECT_ID": "$FIREBASE_PROJECT_ID",
    "FIREBASE_PRIVATE_KEY_ID": "$FIREBASE_PRIVATE_KEY_ID",
    "FIREBASE_PRIVATE_KEY": "$FIREBASE_PRIVATE_KEY",
    "FIREBASE_CLIENT_EMAIL": "$FIREBASE_CLIENT_EMAIL",
    "FIREBASE_CLIENT_ID": "$FIREBASE_CLIENT_ID"
  }
}
EOF
          
          export DB_HOST="${{ secrets.DB_HOST }}"
          export DB_NAME="${{ secrets.DB_NAME }}"
          export DB_USER="${{ secrets.DB_USER }}"
          export DB_PASSWORD="${{ secrets.DB_PASSWORD }}"
          export REDIS_HOST="${{ secrets.REDIS_HOST }}"
          export REDIS_PORT="${{ secrets.REDIS_PORT }}"
          export FIREBASE_PROJECT_ID="${{ secrets.FIREBASE_PROJECT_ID }}"
          export FIREBASE_PRIVATE_KEY_ID="${{ secrets.FIREBASE_PRIVATE_KEY_ID }}"
          export FIREBASE_PRIVATE_KEY="${{ secrets.FIREBASE_PRIVATE_KEY }}"
          export FIREBASE_CLIENT_EMAIL="${{ secrets.FIREBASE_CLIENT_EMAIL }}"
          export FIREBASE_CLIENT_ID="${{ secrets.FIREBASE_CLIENT_ID }}"
          
          envsubst < env_snow.json > env_snow_final.json
          
          aws lambda update-function-configuration \
            --function-name resort-data-snow-checker \
            --environment file://env_snow_final.json \
            --region ${{ env.AWS_REGION }}
          
          rm env_snow.json env_snow_final.json
          
          echo "âœ… Snow Checker ç¯å¢ƒå˜é‡æ›´æ–°å®Œæˆ"
          echo "â³ ç­‰å¾…æ›´æ–°å®Œæˆ..."
          sleep 5
          
          # æ›´æ–° SQS Notification Processor ç¯å¢ƒå˜é‡
          echo "ğŸ”§ æ›´æ–° SQS Notification Processor ç¯å¢ƒå˜é‡..."
          
          # ä½¿ç”¨ JSON æ–‡ä»¶æ¥é¿å…æ¢è¡Œç¬¦é—®é¢˜
          cat > env.json << 'EOF'
{
  "Variables": {
    "SUPABASE_URL": "$SUPABASE_URL",
    "SUPABASE_SERVICE_KEY": "$SUPABASE_SERVICE_KEY",
    "FIREBASE_PROJECT_ID": "$FIREBASE_PROJECT_ID",
    "FIREBASE_PRIVATE_KEY_ID": "$FIREBASE_PRIVATE_KEY_ID",
    "FIREBASE_PRIVATE_KEY": "$FIREBASE_PRIVATE_KEY",
    "FIREBASE_CLIENT_EMAIL": "$FIREBASE_CLIENT_EMAIL",
    "FIREBASE_CLIENT_ID": "$FIREBASE_CLIENT_ID"
  }
}
EOF
          
          # æ›¿æ¢ç¯å¢ƒå˜é‡
          export SUPABASE_URL="${{ secrets.SUPABASE_URL }}"
          export SUPABASE_SERVICE_KEY="${{ secrets.SUPABASE_SERVICE_KEY }}"
          export FIREBASE_PROJECT_ID="${{ secrets.FIREBASE_PROJECT_ID }}"
          export FIREBASE_PRIVATE_KEY_ID="${{ secrets.FIREBASE_PRIVATE_KEY_ID }}"
          export FIREBASE_PRIVATE_KEY="${{ secrets.FIREBASE_PRIVATE_KEY }}"
          export FIREBASE_CLIENT_EMAIL="${{ secrets.FIREBASE_CLIENT_EMAIL }}"
          export FIREBASE_CLIENT_ID="${{ secrets.FIREBASE_CLIENT_ID }}"
          
          envsubst < env.json > env_final.json
          
          aws lambda update-function-configuration \
            --function-name resort-data-sqs-notification-processor \
            --environment file://env_final.json \
            --region ${{ env.AWS_REGION }}
          
          rm env.json env_final.json
          
          echo "âœ… æ‰€æœ‰ç¯å¢ƒå˜é‡æ›´æ–°æˆåŠŸ"

      - name: Trigger Initial Data Collection
        run: |
          echo "ğŸ¯ è§¦å‘ä¸€æ¬¡æ•°æ®é‡‡é›†..."
          
          # ç­‰å¾… Collector Lambda æ›´æ–°å®Œæˆ
          aws lambda wait function-updated \
            --function-name resort-data-collector \
            --region ${{ env.AWS_REGION }} || true
          
          # è°ƒç”¨ Collector Lambda
          aws lambda invoke \
            --function-name resort-data-collector \
            --invocation-type Event \
            --region ${{ env.AWS_REGION }} \
            response.json
          
          echo "âœ… æ•°æ®é‡‡é›†ä»»åŠ¡å·²å¯åŠ¨ï¼ˆå¼‚æ­¥æ‰§è¡Œï¼‰"
          echo "ğŸ“Š æŸ¥çœ‹é‡‡é›†æ—¥å¿—:"
          echo "   AWS Console â†’ CloudWatch Logs â†’ /aws/lambda/resort-data-collector"

      - name: Deployment Summary
        run: |
          echo ""
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "âœ… Lambda å‡½æ•°éƒ¨ç½²å®Œæˆï¼"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""
          echo "ğŸ“¡ API è®¿é—®åœ°å€:"
          echo "   https://api.steponsnow.com/api/resorts"
          echo ""
          echo "ğŸ¯ æ•°æ®é‡‡é›†:"
          echo "   âœ… éƒ¨ç½²åè‡ªåŠ¨è§¦å‘äº†ä¸€æ¬¡æ•°æ®é‡‡é›†"
          echo "   â° å®šæ—¶ä»»åŠ¡: æ¯3å°æ—¶è‡ªåŠ¨é‡‡é›†"
          echo ""
          echo "ğŸ”§ éªŒè¯éƒ¨ç½²:"
          echo "   curl https://api.steponsnow.com/api/status"
          echo ""
          echo "ğŸ“Š æŸ¥çœ‹æ—¥å¿—:"
          echo "   AWS Console â†’ CloudWatch Logs"
          echo "   - /aws/lambda/resort-data-api"
          echo "   - /aws/lambda/resort-data-collector"
          echo "   - /aws/lambda/resort-data-notification-handler"
          echo "   - /aws/lambda/resort-data-snow-checker"
          echo ""
          echo "ğŸ”” æ¨é€é€šçŸ¥:"
          echo "   - Notification Handler: æ¯åˆ†é’Ÿæ£€æŸ¥é˜Ÿåˆ—"
          echo "   - Snow Checker: æ¯å°æ—¶æ£€æŸ¥é™é›ª"
          echo ""
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
