name: Deploy Lambda Functions

on:
  push:
    branches:
      - main
    paths:
      - '**/*.py'
      - 'requirements.txt'
      - 'resorts_config.json'
      - '.github/workflows/deploy.yml'
  workflow_dispatch:

env:
  AWS_REGION: us-west-2

jobs:
  deploy:
    name: Build and Deploy Lambda Functions
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Build API Lambda package
        run: |
          echo "ğŸ“¦ æ„å»º API Lambda éƒ¨ç½²åŒ…..."
          
          # å®‰è£…ä¾èµ–
          pip install -r requirements.txt -t package/
          
          # å¤åˆ¶ä»£ç æ–‡ä»¶
          cp *.py package/
          cp *.json package/
          cp -r collectors package/
          
          # åˆ›å»ºéƒ¨ç½²åŒ…
          cd package
          zip -r ../api-lambda.zip .
          cd ..
          
          echo "âœ… API Lambda åŒ…æ„å»ºå®Œæˆ"
          ls -lh api-lambda.zip

      - name: Build Collector Lambda package
        run: |
          echo "ğŸ“¦ æ„å»º Collector Lambda éƒ¨ç½²åŒ…..."
          
          # ç¡®ä¿ collectors ç›®å½•åœ¨ package ä¸­
          ls -la package/ | grep collectors || echo "Warning: collectors not found"
          
          # åˆ›å»º collector handler
          cat > package/collector_handler.py << 'EOF'
          #!/usr/bin/env python3
          # -*- coding: utf-8 -*-
          """Lambda å‡½æ•° - é›ªåœºæ•°æ®é‡‡é›†"""
          
          import json
          import sys
          import os
          from datetime import datetime
          
          sys.path.insert(0, os.path.dirname(os.path.abspath(__file__)))
          
          from resort_manager import ResortDataManager
          from failure_tracker import CollectionFailureTracker
          from collection_report_generator import CollectionReportGenerator
          
          def lambda_handler(event, context):
              """Lambda å¤„ç†å‡½æ•°"""
              print(f"æ”¶åˆ°äº‹ä»¶: {json.dumps(event)}")
              start_time = datetime.now()
              limit = event.get('limit')
              resort_id = event.get('resort_id')
              report_generator = CollectionReportGenerator()
              
              try:
                  manager = ResortDataManager(config_file='resorts_config.json')
                  failure_tracker = CollectionFailureTracker()
                  
                  # å•ä¸ªé›ªåœºé‡‡é›†
                  if resort_id:
                      resort_config = None
                      for r in manager.resorts:
                          if r.get('id') == resort_id:
                              resort_config = r
                              break
                      
                      if not resort_config:
                          return {'statusCode': 404, 'body': json.dumps({'error': f'Resort ID {resort_id} not found'})}
                      
                      print(f"é‡‡é›†å•ä¸ªé›ªåœº: {resort_config.get('name')}")
                      data = manager.collect_resort_data(resort_config)
                      
                      if data:
                          manager.save_data([data])
                          end_time = datetime.now()
                          stats = {
                              'start_time': start_time, 'end_time': end_time,
                              'total_resorts': 1, 'success_count': 1, 'fail_count': 0,
                              'failed_resorts': [], 'data_quality': {}
                          }
                          generate_and_upload_report(report_generator, stats)
                          return {'statusCode': 200, 'body': json.dumps({'message': 'Data collected successfully', 'resort': resort_config.get('name')})}
                      else:
                          end_time = datetime.now()
                          stats = {
                              'start_time': start_time, 'end_time': end_time,
                              'total_resorts': 1, 'success_count': 0, 'fail_count': 1,
                              'failed_resorts': [{'name': resort_config.get('name'), 'error': 'Collection failed'}],
                              'data_quality': {}
                          }
                          generate_and_upload_report(report_generator, stats)
                          return {'statusCode': 500, 'body': json.dumps({'error': 'Collection failed'})}
                  
                  # æ‰¹é‡é‡‡é›†
                  resorts_to_collect = [r for r in manager.resorts if r.get('enabled', False)]
                  if limit:
                      resorts_to_collect = resorts_to_collect[:limit]
                  
                  print(f"å¼€å§‹é‡‡é›† {len(resorts_to_collect)} ä¸ªé›ªåœº")
                  results = []
                  failed_resorts = []
                  
                  for resort_config in resorts_to_collect:
                      resort_name = resort_config.get('name')
                      print(f"ğŸ“ é‡‡é›†: {resort_name}")
                      try:
                          data = manager.collect_resort_data(resort_config)
                          if data:
                              results.append(data)
                          else:
                              failed_resorts.append({'name': resort_name, 'error': 'Collection returned None'})
                      except Exception as e:
                          failed_resorts.append({'name': resort_name, 'error': str(e)})
                          print(f"  âŒ å¤±è´¥: {e}")
                  
                  if results:
                      manager.save_data(results)
                  
                  end_time = datetime.now()
                  stats = {
                      'start_time': start_time, 'end_time': end_time,
                      'total_resorts': len(resorts_to_collect),
                      'success_count': len(results), 'fail_count': len(failed_resorts),
                      'failed_resorts': failed_resorts, 'data_quality': {}
                  }
                  report_url = generate_and_upload_report(report_generator, stats)
                  
                  return {
                      'statusCode': 200,
                      'body': json.dumps({
                          'message': f'Collected {len(results)} resorts successfully',
                          'total_resorts': len(resorts_to_collect),
                          'success_count': len(results), 'fail_count': len(failed_resorts),
                          'report_url': report_url
                      })
                  }
              except Exception as e:
                  print(f"âŒ é‡‡é›†å¤±è´¥: {e}")
                  import traceback
                  traceback.print_exc()
                  end_time = datetime.now()
                  stats = {
                      'start_time': start_time, 'end_time': end_time,
                      'total_resorts': 0, 'success_count': 0, 'fail_count': 1,
                      'failed_resorts': [{'name': 'System Error', 'error': str(e)}],
                      'data_quality': {}
                  }
                  try:
                      generate_and_upload_report(report_generator, stats)
                  except:
                      pass
                  return {'statusCode': 500, 'body': json.dumps({'error': str(e), 'errorType': type(e).__name__})}
          
          def generate_and_upload_report(report_generator, stats):
              """ç”Ÿæˆå¹¶ä¸Šä¼ æŠ¥å‘Š"""
              try:
                  html_content = report_generator.generate_report_html(stats)
                  timestamp = stats['start_time'].strftime('%Y%m%d_%H%M%S')
                  filename = f"report_{timestamp}.html"
                  report_url = report_generator.upload_report(html_content, filename)
                  print(f"âœ… æŠ¥å‘Šå·²ç”Ÿæˆ: {report_url}")
                  report_generator.update_index()
                  print(f"âœ… ç´¢å¼•é¡µé¢å·²æ›´æ–°")
                  return report_url
              except Exception as e:
                  print(f"âš ï¸  æŠ¥å‘Šç”Ÿæˆå¤±è´¥: {e}")
                  import traceback
                  traceback.print_exc()
                  return None
          EOF
          
          # åˆ›å»ºéƒ¨ç½²åŒ…
          cd package
          zip -r ../collector-lambda.zip .
          cd ..
          
          echo "âœ… Collector Lambda åŒ…æ„å»ºå®Œæˆ"
          ls -lh collector-lambda.zip
          
          # éªŒè¯åŒ…å†…å®¹
          unzip -l collector-lambda.zip | grep collectors || echo "Warning: collectors not in zip"

      - name: Deploy API Lambda
        run: |
          echo "ğŸš€ éƒ¨ç½² API Lambda å‡½æ•°..."
          
          aws lambda update-function-code \
            --function-name resort-data-api \
            --zip-file fileb://api-lambda.zip \
            --region ${{ env.AWS_REGION }}
          
          echo "âœ… API Lambda éƒ¨ç½²æˆåŠŸ"

      - name: Deploy Collector Lambda
        run: |
          echo "ğŸš€ éƒ¨ç½² Collector Lambda å‡½æ•°..."
          
          aws lambda update-function-code \
            --function-name resort-data-collector \
            --zip-file fileb://collector-lambda.zip \
            --region ${{ env.AWS_REGION }}
          
          echo "âœ… Collector Lambda éƒ¨ç½²æˆåŠŸ"
          
          echo "â³ ç­‰å¾… Lambda æ›´æ–°å®Œæˆ..."
          aws lambda wait function-updated \
            --function-name resort-data-collector \
            --region ${{ env.AWS_REGION }} || true
          
          echo "ğŸ”§ æ›´æ–° Collector Lambda ç¯å¢ƒå˜é‡ (Open-Meteo API Key)..."
          
          # è·å–ç°æœ‰ç¯å¢ƒå˜é‡
          EXISTING_ENV=$(aws lambda get-function-configuration \
            --function-name resort-data-collector \
            --region ${{ env.AWS_REGION }} \
            --query 'Environment.Variables' \
            --output json)
          
          echo "ç°æœ‰ç¯å¢ƒå˜é‡: $EXISTING_ENV"
          
          # ä½¿ç”¨ jq æ·»åŠ  OPENMETEO_API_KEY
          UPDATED_ENV=$(echo $EXISTING_ENV | jq '. + {"OPENMETEO_API_KEY": "${{ secrets.OPENMETEO_API_KEY }}"}')
          
          echo "æ›´æ–°åçš„ç¯å¢ƒå˜é‡: $UPDATED_ENV"
          
          # æ›´æ–° Lambda é…ç½®
          aws lambda update-function-configuration \
            --function-name resort-data-collector \
            --environment "Variables=$UPDATED_ENV" \
            --region ${{ env.AWS_REGION }}
          
          echo "âœ… Collector Lambda ç¯å¢ƒå˜é‡æ›´æ–°å®Œæˆ"

      - name: Build Notification Handler Lambda
        run: |
          echo "ğŸ“¦ æ„å»º Notification Handler Lambda åŒ…..."
          
          # åˆ›å»ºä¸´æ—¶ç›®å½•
          mkdir -p package
          
          # å¤åˆ¶ä»£ç 
          cp notification_handler.py push_service.py package/
          
          # å®‰è£…ä¾èµ–
          pip install -r requirements.txt -t package/ --upgrade
          
          # åˆ›å»ºéƒ¨ç½²åŒ…
          cd package
          zip -r ../notification-handler.zip .
          cd ..
          
          echo "âœ… Notification Handler Lambda åŒ…æ„å»ºå®Œæˆ"
          ls -lh notification-handler.zip

      - name: Build Snow Checker Lambda
        run: |
          echo "ğŸ“¦ æ„å»º Snow Checker Lambda åŒ…..."
          
          # åˆ›å»ºä¸´æ—¶ç›®å½•
          mkdir -p package-snow
          
          # å¤åˆ¶ä»£ç 
          cp check_snow_and_notify.py push_service.py package-snow/
          
          # å®‰è£…ä¾èµ–
          pip install -r requirements.txt -t package-snow/ --upgrade
          
          # åˆ›å»ºéƒ¨ç½²åŒ…
          cd package-snow
          zip -r ../snow-checker.zip .
          cd ..
          
          echo "âœ… Snow Checker Lambda åŒ…æ„å»ºå®Œæˆ"
          ls -lh snow-checker.zip

      - name: Build SQS Notification Processor Lambda
        run: |
          echo "ğŸ“¦ æ„å»º SQS Notification Processor Lambda åŒ…..."
          
          # åˆ›å»ºä¸´æ—¶ç›®å½•
          mkdir -p package-sqs
          
          # å¤åˆ¶ä»£ç 
          cp sqs_notification_processor.py push_service.py package-sqs/
          
          # å®‰è£… Lambda ä¸“ç”¨ä¾èµ–
          pip install -r requirements-lambda.txt -t package-sqs/ --upgrade
          
          # åˆ›å»ºéƒ¨ç½²åŒ…
          cd package-sqs
          zip -r ../sqs-notification-processor.zip .
          cd ..
          
          echo "âœ… SQS Notification Processor Lambda åŒ…æ„å»ºå®Œæˆ"
          ls -lh sqs-notification-processor.zip

      - name: Deploy Notification Handler Lambda
        run: |
          echo "ğŸš€ éƒ¨ç½² Notification Handler Lambda å‡½æ•°..."
          
          aws lambda update-function-code \
            --function-name resort-data-notification-handler \
            --zip-file fileb://notification-handler.zip \
            --region ${{ env.AWS_REGION }}
          
          echo "âœ… Notification Handler Lambda éƒ¨ç½²æˆåŠŸ"

      - name: Deploy Snow Checker Lambda
        run: |
          echo "ğŸš€ éƒ¨ç½² Snow Checker Lambda å‡½æ•°..."
          
          aws lambda update-function-code \
            --function-name resort-data-snow-checker \
            --zip-file fileb://snow-checker.zip \
            --region ${{ env.AWS_REGION }}
          
          echo "âœ… Snow Checker Lambda éƒ¨ç½²æˆåŠŸ"
          echo "â³ ç­‰å¾… Lambda æ›´æ–°å®Œæˆ..."
          sleep 10

      - name: Deploy SQS Notification Processor Lambda
        run: |
          echo "ğŸš€ éƒ¨ç½² SQS Notification Processor Lambda å‡½æ•°..."
          
          aws lambda update-function-code \
            --function-name resort-data-sqs-notification-processor \
            --zip-file fileb://sqs-notification-processor.zip \
            --region ${{ env.AWS_REGION }}
          
          echo "âœ… SQS Notification Processor Lambda éƒ¨ç½²æˆåŠŸ"

      - name: Update Lambda Environment Variables
        run: |
          echo "ğŸ”§ æ›´æ–° Lambda ç¯å¢ƒå˜é‡ï¼ˆFirebase é…ç½®ï¼‰..."
          
          # ç­‰å¾…æ‰€æœ‰ Lambda å‡½æ•°æ›´æ–°å®Œæˆ
          echo "â³ ç­‰å¾…æ‰€æœ‰ Lambda å‡½æ•°å°±ç»ª..."
          aws lambda wait function-updated \
            --function-name resort-data-notification-handler \
            --region ${{ env.AWS_REGION }} || true
          
          aws lambda wait function-updated \
            --function-name resort-data-snow-checker \
            --region ${{ env.AWS_REGION }} || true
          
          aws lambda wait function-updated \
            --function-name resort-data-sqs-notification-processor \
            --region ${{ env.AWS_REGION }} || true
          
          echo "âœ… æ‰€æœ‰ Lambda å‡½æ•°å·²å°±ç»ª"
          
          # æ›´æ–° Notification Handler ç¯å¢ƒå˜é‡
          echo "ğŸ”§ æ›´æ–° Notification Handler ç¯å¢ƒå˜é‡..."
          
          echo '{
            "Variables": {
              "SUPABASE_URL": "${{ secrets.SUPABASE_URL }}",
              "SUPABASE_SERVICE_KEY": "${{ secrets.SUPABASE_SERVICE_KEY }}",
              "FIREBASE_PROJECT_ID": "${{ secrets.FIREBASE_PROJECT_ID }}",
              "FIREBASE_PRIVATE_KEY_ID": "${{ secrets.FIREBASE_PRIVATE_KEY_ID }}",
              "FIREBASE_PRIVATE_KEY": "${{ secrets.FIREBASE_PRIVATE_KEY }}",
              "FIREBASE_CLIENT_EMAIL": "${{ secrets.FIREBASE_CLIENT_EMAIL }}",
              "FIREBASE_CLIENT_ID": "${{ secrets.FIREBASE_CLIENT_ID }}"
            }
          }' > env_handler_final.json
          
          aws lambda update-function-configuration \
            --function-name resort-data-notification-handler \
            --environment file://env_handler_final.json \
            --region ${{ env.AWS_REGION }}
          
          rm env_handler_final.json
          
          echo "âœ… Notification Handler ç¯å¢ƒå˜é‡æ›´æ–°å®Œæˆ"
          echo "â³ ç­‰å¾…æ›´æ–°å®Œæˆ..."
          sleep 5
          
          # æ›´æ–° Snow Checker ç¯å¢ƒå˜é‡
          echo "ğŸ”§ æ›´æ–° Snow Checker ç¯å¢ƒå˜é‡..."
          
          echo '{
            "Variables": {
              "DB_HOST": "${{ secrets.DB_HOST }}",
              "DB_NAME": "${{ secrets.DB_NAME }}",
              "DB_USER": "${{ secrets.DB_USER }}",
              "DB_PASSWORD": "${{ secrets.DB_PASSWORD }}",
              "REDIS_HOST": "${{ secrets.REDIS_HOST }}",
              "REDIS_PORT": "${{ secrets.REDIS_PORT }}",
              "FIREBASE_PROJECT_ID": "${{ secrets.FIREBASE_PROJECT_ID }}",
              "FIREBASE_PRIVATE_KEY_ID": "${{ secrets.FIREBASE_PRIVATE_KEY_ID }}",
              "FIREBASE_PRIVATE_KEY": "${{ secrets.FIREBASE_PRIVATE_KEY }}",
              "FIREBASE_CLIENT_EMAIL": "${{ secrets.FIREBASE_CLIENT_EMAIL }}",
              "FIREBASE_CLIENT_ID": "${{ secrets.FIREBASE_CLIENT_ID }}"
            }
          }' > env_snow_final.json
          
          aws lambda update-function-configuration \
            --function-name resort-data-snow-checker \
            --environment file://env_snow_final.json \
            --region ${{ env.AWS_REGION }}
          
          rm env_snow_final.json
          
          echo "âœ… Snow Checker ç¯å¢ƒå˜é‡æ›´æ–°å®Œæˆ"
          echo "â³ ç­‰å¾…æ›´æ–°å®Œæˆ..."
          sleep 5
          
          # æ›´æ–° SQS Notification Processor ç¯å¢ƒå˜é‡
          echo "ğŸ”§ æ›´æ–° SQS Notification Processor ç¯å¢ƒå˜é‡..."
          
          echo '{
            "Variables": {
              "SUPABASE_URL": "${{ secrets.SUPABASE_URL }}",
              "SUPABASE_SERVICE_KEY": "${{ secrets.SUPABASE_SERVICE_KEY }}",
              "FIREBASE_PROJECT_ID": "${{ secrets.FIREBASE_PROJECT_ID }}",
              "FIREBASE_PRIVATE_KEY_ID": "${{ secrets.FIREBASE_PRIVATE_KEY_ID }}",
              "FIREBASE_PRIVATE_KEY": "${{ secrets.FIREBASE_PRIVATE_KEY }}",
              "FIREBASE_CLIENT_EMAIL": "${{ secrets.FIREBASE_CLIENT_EMAIL }}",
              "FIREBASE_CLIENT_ID": "${{ secrets.FIREBASE_CLIENT_ID }}"
            }
          }' > env_final.json
          
          aws lambda update-function-configuration \
            --function-name resort-data-sqs-notification-processor \
            --environment file://env_final.json \
            --region ${{ env.AWS_REGION }}
          
          rm env_final.json
          
          echo "âœ… æ‰€æœ‰ç¯å¢ƒå˜é‡æ›´æ–°æˆåŠŸ"

      - name: Trigger Initial Data Collection
        run: |
          echo "ğŸ¯ è§¦å‘ä¸€æ¬¡æ•°æ®é‡‡é›†..."
          
          # ç­‰å¾… Collector Lambda æ›´æ–°å®Œæˆ
          aws lambda wait function-updated \
            --function-name resort-data-collector \
            --region ${{ env.AWS_REGION }} || true
          
          # è°ƒç”¨ Collector Lambda
          aws lambda invoke \
            --function-name resort-data-collector \
            --invocation-type Event \
            --region ${{ env.AWS_REGION }} \
            response.json
          
          echo "âœ… æ•°æ®é‡‡é›†ä»»åŠ¡å·²å¯åŠ¨ï¼ˆå¼‚æ­¥æ‰§è¡Œï¼‰"
          echo "ğŸ“Š æŸ¥çœ‹é‡‡é›†æ—¥å¿—:"
          echo "   AWS Console â†’ CloudWatch Logs â†’ /aws/lambda/resort-data-collector"

      - name: Deployment Summary
        run: |
          echo ""
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "âœ… Lambda å‡½æ•°éƒ¨ç½²å®Œæˆï¼"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""
          echo "ğŸ“¡ API è®¿é—®åœ°å€:"
          echo "   https://api.steponsnow.com/api/resorts"
          echo ""
          echo "ğŸ¯ æ•°æ®é‡‡é›†:"
          echo "   âœ… éƒ¨ç½²åè‡ªåŠ¨è§¦å‘äº†ä¸€æ¬¡æ•°æ®é‡‡é›†"
          echo "   â° å®šæ—¶ä»»åŠ¡: æ¯3å°æ—¶è‡ªåŠ¨é‡‡é›†"
          echo ""
          echo "ğŸ”§ éªŒè¯éƒ¨ç½²:"
          echo "   curl https://api.steponsnow.com/api/status"
          echo ""
          echo "ğŸ“Š æŸ¥çœ‹æ—¥å¿—:"
          echo "   AWS Console â†’ CloudWatch Logs"
          echo "   - /aws/lambda/resort-data-api"
          echo "   - /aws/lambda/resort-data-collector"
          echo "   - /aws/lambda/resort-data-notification-handler"
          echo "   - /aws/lambda/resort-data-snow-checker"
          echo ""
          echo "ğŸ”” æ¨é€é€šçŸ¥:"
          echo "   - Notification Handler: æ¯åˆ†é’Ÿæ£€æŸ¥é˜Ÿåˆ—"
          echo "   - Snow Checker: æ¯å°æ—¶æ£€æŸ¥é™é›ª"
          echo ""
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
