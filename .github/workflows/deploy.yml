name: Deploy to AWS

on:
  push:
    branches:
      - main  # æŽ¨é€åˆ° main åˆ†æ”¯æ—¶è§¦å‘
    paths:
      - '**/*.py'
      - 'requirements.txt'
      - 'terraform/**'
      - '.github/workflows/**'
  workflow_dispatch:  # å…è®¸æ‰‹åŠ¨è§¦å‘

env:
  AWS_REGION: us-west-2
  TERRAFORM_VERSION: 1.6.0

jobs:
  # æž„å»º Lambda éƒ¨ç½²åŒ…
  build-lambda:
    name: Build Lambda Packages
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
                uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Build API Lambda package
        run: |
          # å®‰è£…ä¾èµ–
          pip install -r requirements.txt -t package/
          pip install awsgi -t package/
          
          # å¤åˆ¶ä»£ç æ–‡ä»¶
          cp *.py package/
          
          # åˆ›å»ºéƒ¨ç½²åŒ…
          cd package
          zip -r ../api-lambda.zip .
          cd ..
          
          echo "âœ… API Lambda package built: api-lambda.zip"
          ls -lh api-lambda.zip

      - name: Build Collector Lambda package
        run: |
          # ä½¿ç”¨ç›¸åŒçš„ package (å·²æœ‰ä¾èµ–)
          cd package
          
          # åˆ›å»º collector handler
          cat > collector_handler.py << 'EOF'
          #!/usr/bin/env python3
          import json
          from collect_data import main as collect_data_main

          def lambda_handler(event, context):
              """
              Lambda å…¥å£å‡½æ•° - æ•°æ®é‡‡é›†
              """
              try:
                  print("ðŸš€ å¼€å§‹æ•°æ®é‡‡é›†...")
                  collect_data_main()
                  print("âœ… æ•°æ®é‡‡é›†å®Œæˆ")
                  
                  return {
                      'statusCode': 200,
                      'body': json.dumps({
                          'message': 'Data collection completed successfully'
                      })
                  }
              except Exception as e:
                  print(f"âŒ æ•°æ®é‡‡é›†å¤±è´¥: {e}")
                  return {
                      'statusCode': 500,
                      'body': json.dumps({
                          'error': str(e)
                      })
                  }
          EOF
          
          # åˆ›å»ºéƒ¨ç½²åŒ…
          zip -r ../collector-lambda.zip .
          cd ..
          
          echo "âœ… Collector Lambda package built: collector-lambda.zip"
          ls -lh collector-lambda.zip

              - name: Upload Lambda packages
                uses: actions/upload-artifact@v4
                with:
                  name: lambda-packages
                  path: |
                    api-lambda.zip
                    collector-lambda.zip
                  retention-days: 7

  # éƒ¨ç½²åŸºç¡€è®¾æ–½
  deploy-infrastructure:
    name: Deploy Infrastructure
    runs-on: ubuntu-latest
    needs: build-lambda
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download Lambda packages
        uses: actions/download-artifact@v4
        with:
          name: lambda-packages
          path: ./

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TERRAFORM_VERSION }}

      - name: Terraform Init
        working-directory: terraform
        run: terraform init

      - name: Terraform Plan
        working-directory: terraform
        run: |
          terraform plan \
            -var="db_password=${{ secrets.DB_PASSWORD }}" \
            -out=tfplan

      - name: Terraform Apply
        if: github.ref == 'refs/heads/main'
        working-directory: terraform
        run: terraform apply -auto-approve tfplan

      - name: Get Terraform Outputs
        working-directory: terraform
        run: |
          echo "ðŸ“¡ API Gateway URL:"
          terraform output -raw api_gateway_url || echo "N/A"
          
          echo ""
          echo "ðŸ—„ï¸ RDS Address:"
          terraform output -raw rds_address || echo "N/A"
          
          echo ""
          echo "ðŸ“¦ Lambda Functions:"
          terraform output -raw lambda_api_function_name || echo "N/A"
          terraform output -raw lambda_collector_function_name || echo "N/A"

  # ä¸Šä¼  Lambda ä»£ç åˆ° S3 å¹¶æ›´æ–°å‡½æ•°
  update-lambda:
    name: Update Lambda Functions
    runs-on: ubuntu-latest
    needs: [build-lambda, deploy-infrastructure]
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download Lambda packages
        uses: actions/download-artifact@v4
        with:
          name: lambda-packages
          path: ./

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Upload Lambda packages to S3
        run: |
          BUCKET_NAME="resort-data-lambda-artifacts-${{ secrets.AWS_ACCOUNT_ID }}"
          
          echo "ðŸ“¦ ä¸Šä¼  API Lambda åŒ…..."
          aws s3 cp api-lambda.zip s3://$BUCKET_NAME/api-lambda.zip
          
          echo "ðŸ“¦ ä¸Šä¼  Collector Lambda åŒ…..."
          aws s3 cp collector-lambda.zip s3://$BUCKET_NAME/collector-lambda.zip
          
          echo "âœ… Lambda åŒ…ä¸Šä¼ å®Œæˆ"

      - name: Update Lambda functions
        run: |
          echo "ðŸ”„ æ›´æ–° API Lambda å‡½æ•°..."
          aws lambda update-function-code \
            --function-name resort-data-api \
            --s3-bucket resort-data-lambda-artifacts-${{ secrets.AWS_ACCOUNT_ID }} \
            --s3-key api-lambda.zip \
            --region ${{ env.AWS_REGION }}
          
          echo "ðŸ”„ æ›´æ–° Collector Lambda å‡½æ•°..."
          aws lambda update-function-code \
            --function-name resort-data-collector \
            --s3-bucket resort-data-lambda-artifacts-${{ secrets.AWS_ACCOUNT_ID }} \
            --s3-key collector-lambda.zip \
            --region ${{ env.AWS_REGION }}
          
          echo "âœ… Lambda å‡½æ•°æ›´æ–°å®Œæˆ"

      - name: Wait for Lambda updates
        run: |
          echo "â³ ç­‰å¾… Lambda å‡½æ•°æ›´æ–°..."
          sleep 30
          
          echo "âœ… éƒ¨ç½²å®Œæˆï¼"

